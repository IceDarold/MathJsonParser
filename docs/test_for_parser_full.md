# Техническое задание: Идеальная система тестирования MathIR Parser

## 1. Цель проекта
Создать абсолютно идеальную, всеобъемлющую систему тестирования для MathIR Parser, обеспечивающую 100% надежность, полное покрытие функциональности и автоматическую валидацию качества.

## 2. Архитектура тестирования

### 2.1 Структура тестов
```
tests/
├── unit/                    # Unit тесты отдельных функций
│   ├── test_latex_parsing.py
│   ├── test_sympy_conversion.py
│   ├── test_runtime_context.py
│   └── test_validation.py
├── integration/             # Интеграционные тесты
│   ├── test_full_pipeline.py
│   ├── test_error_handling.py
│   └── test_logging.py
├── end_to_end/             # End-to-end тесты
│   ├── test_mathematical_accuracy.py
│   ├── test_performance.py
│   └── test_real_world_cases.py
├── regression/             # Регрессионные тесты
│   ├── test_critical_fixes.py
│   └── test_backward_compatibility.py
├── stress/                 # Стресс тесты
│   ├── test_large_expressions.py
│   ├── test_memory_usage.py
│   └── test_concurrent_processing.py
├── fixtures/               # Тестовые данные
│   ├── mathematical_expressions/
│   ├── expected_results/
│   └── edge_cases/
└── utils/                  # Утилиты для тестирования
    ├── test_helpers.py
    ├── assertion_helpers.py
    └── data_generators.py
```

## 3. Детальные требования к тестам

### 3.1 Unit тесты (tests/unit/)

#### 3.1.1 `test_latex_parsing.py`
**Цель**: Тестирование функции `to_sympy_expr` в изоляции

**Покрытие:**
- ✅ Базовые LaTeX команды: `\sqrt{}`, `\frac{}{}`, `\pi`, `\infty`
- ✅ Греческие буквы: `\alpha`, `\beta`, `\gamma`, etc.
- ✅ Тригонометрические функции: `\sin`, `\cos`, `\tan`, `\ln`, `\log`
- ✅ Неявное умножение: `2x`, `(x+1)(x+2)`, `sin 2x`
- ✅ Абсолютные значения: `|expr|`, `||nested||`
- ✅ Степени: `x^2`, `e^{2x}`, `x^{y+1}`
- ✅ Вложенные выражения: `\frac{\sqrt{x+1}}{x^2+1}`
- ✅ Граничные случаи: пустые строки, некорректный LaTeX
- ✅ Производительность: время парсинга сложных выражений

**Тестовые случаи (минимум 50):**
```python
test_cases = [
    # Базовые команды
    ("\\sqrt{4}", "2"),
    ("\\frac{1}{2}", "0.5"),
    ("\\pi", "3.14159..."),
    
    # Сложные случаи
    ("\\frac{\\sqrt{x+1}}{\\sin(\\pi x)}", "sqrt(x+1)/sin(pi*x)"),
    ("2\\sin 3x + \\cos^2 y", "2*sin(3*x) + cos(y)**2"),
    
    # Граничные случаи
    ("", "error"),
    ("\\invalid{command}", "error"),
    ("\\frac{1}{0}", "zoo"),  # SymPy infinity
]
```

#### 3.1.2 `test_sympy_conversion.py`
**Цель**: Тестирование корректности преобразования в SymPy

**Покрытие:**
- Типы SymPy объектов: Symbol, Function, Matrix, etc.
- Домены символов: R, Z, N, C
- Математические константы: π, e, ∞
- Функции: sin, cos, log, exp, etc.

#### 3.1.3 `test_runtime_context.py`
**Цель**: Тестирование построения и управления контекстом

**Покрытие:**
- Создание символов с доменами
- Интеграция констант
- Управление функциями и последовательностями
- Контекст для матриц и распределений

#### 3.1.4 `test_validation.py`
**Цель**: Тестирование Pydantic валидации

**Покрытие:**
- Валидация всех типов Target
- Проверка схемы MathIR
- Обработка некорректных данных
- Валидация распределений и геометрии

### 3.2 Интеграционные тесты (tests/integration/)

#### 3.2.1 `test_full_pipeline.py`
**Цель**: Тестирование полного pipeline обработки

**Покрытие:**
- JSON → MathIR → Runtime → Execution → Output
- Различные комбинации targets
- Сложные математические задачи
- Многоэтапные вычисления

#### 3.2.2 `test_error_handling.py`
**Цель**: Тестирование обработки ошибок

**Покрытие:**
- Некорректный JSON
- Математические ошибки (деление на ноль, etc.)
- Недопустимые операции
- Graceful degradation

### 3.3 End-to-end тесты (tests/end_to_end/)

#### 3.3.1 `test_mathematical_accuracy.py` ⭐⭐⭐⭐⭐
**Цель**: Проверка математической корректности результатов

**Критически важные тесты:**
```python
# Точные математические значения
test_cases = [
    # Интегралы
    ("∫₀¹ x² dx", 1/3),
    ("∫₀^π sin(x) dx", 2),
    ("∫₋∞^∞ e^(-x²) dx", √π),
    
    # Пределы
    ("lim(x→0) sin(x)/x", 1),
    ("lim(n→∞) (1+1/n)ⁿ", e),
    
    # Суммы
    ("∑(n=1 to ∞) 1/n²", π²/6),
    ("∑(n=1 to ∞) 1/(n(n+1))", 1),
    
    # Решения уравнений
    ("x² - 4 = 0", [-2, 2]),
    ("sin(x) = 0.5", [π/6, 5π/6]),
]
```

**Требования:**
- Точность: ±1e-10 для численных результатов
- Покрытие: все типы математических операций
- Эталонные значения: проверенные математически

#### 3.3.2 `test_performance.py`
**Цель**: Тестирование производительности

**Метрики:**
- Время выполнения: <30 сек на задачу
- Память: <500MB на задачу
- Пропускная способность: >100 задач/час
- Масштабируемость: линейный рост времени

#### 3.3.3 `test_real_world_cases.py`
**Цель**: Тестирование на реальных задачах

**Источники:**
- Задачи из error_log.json (исправленные)
- Задачи из success_log.json
- Математические олимпиады
- Университетские курсы

### 3.4 Регрессионные тесты (tests/regression/)

#### 3.4.1 `test_critical_fixes.py` (уже есть)
**Цель**: Предотвращение возврата исправленных ошибок

#### 3.4.2 `test_backward_compatibility.py` (уже есть)
**Цель**: Сохранение работающей функциональности

### 3.5 Стресс тесты (tests/stress/)

#### 3.5.1 `test_large_expressions.py`
**Цель**: Тестирование на больших выражениях

**Примеры:**
- Полиномы высоких степеней
- Глубоко вложенные дроби
- Длинные суммы и произведения
- Сложные интегралы

#### 3.5.2 `test_memory_usage.py`
**Цель**: Контроль потребления памяти

**Метрики:**
- Пиковое потребление памяти
- Утечки памяти
- Эффективность сборки мусора

#### 3.5.3 `test_concurrent_processing.py`
**Цель**: Тестирование параллельной обработки

**Сценарии:**
- Множественные задачи одновременно
- Разделение ресурсов
- Thread safety

## 4. Система валидации результатов

### 4.1 Математическая валидация
```python
class MathematicalValidator:
    def validate_integral(self, result, expected, tolerance=1e-10):
        """Проверка интегралов с учетом численной точности"""
    
    def validate_limit(self, result, expected):
        """Проверка пределов с обработкой бесконечностей"""
    
    def validate_sum(self, result, expected):
        """Проверка сумм с обработкой сходимости"""
```

### 4.2 Автоматическая генерация тестов
```python
class TestGenerator:
    def generate_polynomial_tests(self, max_degree=10):
        """Генерация тестов для полиномов"""
    
    def generate_trigonometric_tests(self):
        """Генерация тестов для тригонометрии"""
    
    def generate_integration_tests(self):
        """Генерация тестов для интегралов"""
```

## 5. Покрытие функциональности

### 5.1 Обязательное покрытие (100%)

#### Математические операции:
- ✅ **Интегралы**: определенные, неопределенные, двойные
- ✅ **Пределы**: конечные, бесконечные, односторонние
- ✅ **Суммы**: конечные, бесконечные, с условиями
- ✅ **Решение уравнений**: линейные, квадратные, трансцендентные
- ✅ **Неравенства**: линейные, квадратные, системы
- ✅ **Матрицы**: операции, определители, обращение
- ✅ **Вероятности**: распределения, события
- ✅ **Геометрия**: линии, окружности, параболы
- ✅ **Оптимизация**: максимумы, минимумы

#### LaTeX конструкции:
- ✅ **Команды**: `\sqrt{}`, `\frac{}{}`, `\sin`, `\cos`, etc.
- ✅ **Символы**: `\pi`, `\infty`, греческие буквы
- ✅ **Операторы**: `\cdot`, `\pm`, `\mp`
- ✅ **Индексы**: `x_1`, `a_{n+1}`
- ✅ **Степени**: `x^2`, `e^{2x}`

#### Форматы данных:
- ✅ **Входные**: JSON, MathIR
- ✅ **Выходные**: decimal, exact, rounded
- ✅ **Ошибки**: structured error responses

### 5.2 Граничные случаи (Edge Cases)

#### Математические:
- Деление на ноль → `zoo` (SymPy infinity)
- Неопределенности: `0/0`, `∞/∞`
- Комплексные числа
- Очень большие/маленькие числа
- Иррациональные результаты

#### Технические:
- Пустые входные данные
- Некорректный JSON
- Отсутствующие поля
- Неподдерживаемые операции
- Превышение лимитов времени/памяти

## 6. Метрики качества

### 6.1 Покрытие кода
- **Целевое покрытие**: 95%+
- **Инструменты**: pytest-cov, coverage.py
- **Отчеты**: HTML, XML, консоль

### 6.2 Математическая точность
- **Численная точность**: ±1e-10
- **Символьная корректность**: точное соответствие
- **Эталонные значения**: проверенные математически

### 6.3 Производительность
- **Время выполнения**: <30 сек/задача
- **Память**: <500MB/задача
- **Пропускная способность**: >100 задач/час

## 7. Конкретные тестовые наборы

### 7.1 Набор "Золотой стандарт" (100 тестов)
```python
GOLDEN_STANDARD_TESTS = [
    # Классические интегралы (20 тестов)
    {"expr": "∫₀¹ x dx", "expected": 0.5, "tolerance": 1e-15},
    {"expr": "∫₀^π sin(x) dx", "expected": 2.0, "tolerance": 1e-15},
    {"expr": "∫₋∞^∞ e^(-x²) dx", "expected": "sqrt(pi)", "tolerance": 1e-10},
    
    # Знаменитые пределы (20 тестов)
    {"expr": "lim(x→0) sin(x)/x", "expected": 1.0, "tolerance": 1e-15},
    {"expr": "lim(n→∞) (1+1/n)ⁿ", "expected": "E", "tolerance": 1e-10},
    
    # Классические суммы (20 тестов)
    {"expr": "∑(n=1 to ∞) 1/n²", "expected": "pi**2/6", "tolerance": 1e-10},
    {"expr": "∑(n=1 to ∞) 1/2ⁿ", "expected": 1.0, "tolerance": 1e-15},
    
    # Алгебраические уравнения (20 тестов)
    {"expr": "x² - 4 = 0", "expected": [-2, 2], "type": "solve"},
    {"expr": "x³ - 1 = 0", "expected": [1, "complex_roots"], "type": "solve"},
    
    # Матричные операции (20 тестов)
    {"matrix": "[[1,2],[3,4]]", "operation": "det", "expected": -2},
    {"matrix": "[[1,0],[0,1]]", "operation": "inv", "expected": "identity"},
]
```

### 7.2 Набор "Стресс тест" (50 тестов)
```python
STRESS_TESTS = [
    # Большие выражения
    {"expr": "x^100 + x^99 + ... + x + 1", "operation": "factor"},
    {"expr": "∫₀¹⁰⁰ x^50 * e^(-x) dx", "operation": "integrate"},
    
    # Глубокая вложенность
    {"expr": "\\frac{\\frac{\\frac{1}{x}}{y}}{z}", "operation": "simplify"},
    
    # Множественные переменные
    {"expr": "∫∫∫ x*y*z dx dy dz", "limits": "complex", "operation": "integrate"},
]
```

### 7.3 Набор "Реальные задачи" (200 тестов)
- Задачи из математических олимпиад
- Университетские экзамены
- Инженерные расчеты
- Физические формулы

## 8. Автоматизация тестирования

### 8.1 Continuous Integration
```yaml
# .github/workflows/test.yml
name: MathIR Parser Tests
on: [push, pull_request]
jobs:
  test:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: [3.9, 3.10, 3.11, 3.12]
    steps:
      - uses: actions/checkout@v3
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ matrix.python-version }}
      - name: Install dependencies
        run: pip install -r requirements.txt
      - name: Run unit tests
        run: pytest tests/unit/ -v --cov=mathir_parser
      - name: Run integration tests
        run: pytest tests/integration/ -v
      - name: Run end-to-end tests
        run: pytest tests/end_to_end/ -v
      - name: Run performance tests
        run: pytest tests/stress/ -v --timeout=300
```

### 8.2 Автоматическая генерация отчетов
```python
class TestReporter:
    def generate_coverage_report(self):
        """HTML отчет о покрытии кода"""
    
    def generate_performance_report(self):
        """Отчет о производительности"""
    
    def generate_accuracy_report(self):
        """Отчет о математической точности"""
    
    def generate_regression_report(self):
        """Отчет о регрессиях"""
```

## 9. Специализированные тесты

### 9.1 Тесты точности (Accuracy Tests)
```python
def test_mathematical_constants():
    """Проверка математических констант"""
    assert abs(compute_pi() - math.pi) < 1e-15
    assert abs(compute_e() - math.e) < 1e-15

def test_known_integrals():
    """Проверка известных интегралов"""
    # ∫₀¹ x² dx = 1/3
    result = integrate("x^2", "x", 0, 1)
    assert abs(result - 1/3) < 1e-15

def test_famous_limits():
    """Проверка знаменитых пределов"""
    # lim(x→0) sin(x)/x = 1
    result = limit("sin(x)/x", "x", 0)
    assert abs(result - 1) < 1e-15
```

### 9.2 Тесты производительности
```python
def test_performance_benchmarks():
    """Бенчмарки производительности"""
    
    @pytest.mark.timeout(30)
    def test_complex_integral():
        # Должен выполниться за <30 сек
        result = integrate("sin(x)*cos(x)*exp(x)", "x", 0, 10)
    
    @pytest.mark.memory_limit("500MB")
    def test_memory_usage():
        # Не должен превышать 500MB
        result = process_large_expression()
```

### 9.3 Тесты совместимости
```python
def test_sympy_versions():
    """Тестирование с разными версиями SymPy"""
    
def test_python_versions():
    """Тестирование с разными версиями Python"""
    
def test_platform_compatibility():
    """Тестирование на разных ОС"""
```

## 10. Система мониторинга качества

### 10.1 Автоматические проверки
- **Pre-commit hooks**: запуск тестов перед коммитом
- **CI/CD pipeline**: полное тестирование при push
- **Nightly builds**: ежедневное тестирование на больших наборах

### 10.2 Метрики качества
```python
class QualityMetrics:
    def code_coverage(self) -> float:
        """Покрытие кода тестами"""
    
    def mathematical_accuracy(self) -> float:
        """Процент математически корректных результатов"""
    
    def performance_score(self) -> float:
        """Оценка производительности"""
    
    def reliability_score(self) -> float:
        """Надежность (отсутствие падений)"""
```

## 11. Инструменты и технологии

### 11.1 Основные инструменты
- **pytest**: основной фреймворк тестирования
- **pytest-cov**: покрытие кода
- **pytest-benchmark**: бенчмарки производительности
- **pytest-xdist**: параллельное выполнение тестов
- **hypothesis**: property-based тестирование

### 11.2 Специализированные инструменты
- **SymPy**: математические вычисления и проверки
- **NumPy**: численные сравнения
- **matplotlib**: визуализация результатов тестов
- **memory_profiler**: профилирование памяти

## 12. План реализации

### Фаза 1: Базовая структура (1 неделя)
- Создание структуры папок
- Настройка pytest и CI/CD
- Миграция существующих тестов

### Фаза 2: Unit тесты (2 недели)
- Полное покрытие всех функций
- Граничные случаи
- Валидация входных данных

### Фаза 3: Integration тесты (2 недели)
- Полный pipeline
- Обработка ошибок
- Логирование

### Фаза 4: End-to-end тесты (3 недели)
- Математическая точность
- Производительность
- Реальные задачи

### Фаза 5: Автоматизация (1 неделя)
- CI/CD настройка
- Автоматические отчеты
- Мониторинг качества

## 13. Критерии успеха

### 13.1 Количественные метрики
- **Покрытие кода**: ≥95%
- **Математическая точность**: ≥99.9%
- **Производительность**: 100% тестов <30 сек
- **Надежность**: 0 падений на 1000 тестов

### 13.2 Качественные критерии
- ✅ Все типы математических операций покрыты
- ✅ Все LaTeX конструкции протестированы
- ✅ Все граничные случаи обработаны
- ✅ Полная автоматизация тестирования
- ✅ Детальная документация тестов

## 14. Ожидаемый результат

**Идеальная система тестирования**, которая:
1. **Гарантирует математическую корректность** всех результатов
2. **Предотвращает регрессии** при изменениях кода
3. **Обеспечивает высокую производительность** системы
4. **Автоматически валидирует** новые изменения
5. **Предоставляет детальную отчетность** о качестве

Эта система тестирования сделает MathIR Parser абсолютно надежным и готовым к промышленному использованию.